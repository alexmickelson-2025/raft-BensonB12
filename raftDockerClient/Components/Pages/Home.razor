@page "/"
@using Logic.Models.Server
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

@foreach (string url in Urls)
{
  <div>@url</div>
}

@foreach (ServerInfo serverInfo in servers)
{
  <div>Server Id: @serverInfo.Id</div>
  <div>Server Term: @serverInfo.Term</div>
  <div>Server State: @((ServerNodeState)serverInfo.ServerStateId)</div>
}

@code {
  HttpClient http = new HttpClient();
  string[] Urls = (Environment.GetEnvironmentVariable("NODE_URLS") ?? "").Split(',');
  List<ServerInfo> servers = new List<ServerInfo> { new ServerInfo(), new ServerInfo(), new ServerInfo() };
  Timer? timer;

  protected override void OnInitialized()
  {
    timer = new Timer(async _ =>
    {
      await FetchServerInfo();
      await InvokeAsync(StateHasChanged);
    }, null, 0, 200);
  }

  private async Task FetchServerInfo()
  {
    for (int i = 0; i < Urls.Length; i++)
    {
      try
      {
        var serverInfo = await http.GetFromJsonAsync<ServerInfo>(Urls[i] + "/info");
        if (serverInfo != null)
        {
          servers[i] = serverInfo;
        }
      }
      catch (Exception ex)
      {
        Console.WriteLine($"Error fetching data from {Urls[i]}: {ex.Message}");
      }
    }
  }

  public void Dispose()
  {
    timer?.Dispose();
  }
} using Logic.Models.Server;
